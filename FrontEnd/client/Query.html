<html>

	<head>
	</head>
		<div id="myDiv" style="width:1440px;height:900px;"></div>

	<body>

		<script src="https://npmcdn.com/parse/dist/parse.min.js"></script>
		<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
		<script src="./Plotly.js"></script>
		<script type="text/javascript">

		Parse.initialize("a3Vzn4zfnMObdOfhNJJEdhiFaAdG62rz1Z8ictHmG");
		Parse.serverURL = 'http://jtec-dev.us-east-1.elasticbeanstalk.com/parse'

		/**
		*generate_query() queries the database based on the objectID and calls generate_heatmap on the data retrieved in the query.
		*/
		function generate_query(objectID, completion, valid_threshold){


			objectID = objectID || "";

			var EyeData = Parse.Object.extend("EyeData")
			var query = new Parse.Query(EyeData);

			var categoryPointer = {
				__type: 'Pointer',
				className: "_User",
				objectId: objectID
			};

			query.greaterThanOrEqualTo("valid_percent",valid_threshold)
			query.equalTo("user", categoryPointer);
			query.ascending("createdAt")
			query.find({
				success: function(results) {
					alert("Successfully retrieved " + results.length + " value");
					// Do something with the returned Parse.Object values
				/*	for (var i = 0; i < results.length; i++) {
						var object = results[i];
						alert(object.id + ' has a:' + '\n'+  'x value of ' + object.get('x_array') + '\n' +
						'y value of ' + object.get('y_array') + '\n' +
						'timestamp of ' + object.get('timestamp_array'));
					}*/
					completion(results);

				},
				error: function(error) {
					alert("Error: " + error.code + " " + error.message);
				}
			});



		}
/**
*generate_heatmap() takes the values from the query and generates a two-dimensional array used as input for the make_heatmap call
*/
		function generate_heatmap(data_array)
		{
			x_values = [];  //array for concatenation of all x arrays in queried object
			y_values = [];  //array for concatenation of all y arrays in queried object
			screen_size = [];

			for (var i = 0; i < data_array.length; i++){
				var object = data_array[i];
				for (var j = 0; j < object.get('x_array').length; j++){  //appends all x values from the object queried to x_values
					x_values.push(object.get('x_array')[j])
				}
				for (var k = 0; k < object.get('y_array').length; k++){ //appends retrieves all y values from the object queried to y_values
					y_values.push(object.get('y_array')[k])
				}
				screen_size = object.get('screen_size');
			}

			make_heatmap(x_values, y_values, screen_size);


		}

		generate_query("0BDd1hguOr", generate_heatmap,75);



		</script>


	</body>


</html>
